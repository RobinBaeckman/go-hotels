name: ğŸ§ª CI Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GHCR_USER: robinbaeckman
  GHCR_PAT: ${{ secrets.GHCR_PAT }}
  DOCKER_BUILDKIT: 1

jobs:

  lint:
    name: ğŸ”¢ Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.4'
      - uses: arduino/setup-task@v1
      - uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
      - name: Print env 
        run: task env-check
      - name: Check formatting
        run: task fmt-check
      - name: Run lint
        run: task lint

  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.4'
      - uses: arduino/setup-task@v1
      - name: Generate SQL code
        run: task db-gen
      - name: Run unit tests
        run: task test-unit

  integration:
    name: ğŸ”® Integration Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: gohotels
          POSTGRES_PASSWORD: secret
          POSTGRES_DB: gohotels
        ports: [5432:5432]
        options: >-
          --health-cmd "pg_isready -U gohotels"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgres://gohotels:secret@localhost:5432/gohotels?sslmode=disable
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.4'

      - uses: arduino/setup-task@v1

      - name: â™»ï¸ Cache Go build and bin
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/bin
          key: ${{ runner.os }}-gobin-${{ hashFiles('**/go.sum') }}

      - run: echo "${HOME}/go/bin" >> $GITHUB_PATH

      # - name: Copy CI env
      #   run: cp .env.ci .env

      - name: Run integration tests
        run: task test-integration

  load-tests:
    name: ğŸ”« Load Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: gohotels
          POSTGRES_PASSWORD: secret
          POSTGRES_DB: gohotels
        ports: [5432:5432]
        options: >-
          --health-cmd "pg_isready -U gohotels"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgres://gohotels:secret@localhost:5432/gohotels?sslmode=disable
    steps:
      - name: ğŸ›’ Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Task
        uses: arduino/setup-task@v1

      - name: ğŸ§ª Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.4'

      - name: ğŸ§ª Install k6
        run: |
          sudo mkdir -p /usr/share/keyrings
          curl -s https://dl.k6.io/key.gpg | gpg --dearmor | sudo tee /usr/share/keyrings/k6-archive-keyring.gpg > /dev/null
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install -y k6
      - name: â™»ï¸ Cache Go build and bin
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/bin
          key: ${{ runner.os }}-gobin-${{ hashFiles('**/go.sum') }}

      - run: echo "${HOME}/go/bin" >> $GITHUB_PATH

      - name: ğŸš€ Run Load Tests
        run: task test-load

  security-check:
    name: ğŸ”’ SAST Security Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.4'
      - uses: arduino/setup-task@v1
      - name: Run static security checks
        run: task security-check

  docker-build:
    name: ğŸ› ï¸ Docker Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.4'
      - uses: arduino/setup-task@v1
      - uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ env.GHCR_USER }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build Docker image
        run: task docker-build

  docker-scan:
    name: ğŸ” Trivy Scan
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›’ Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Task
        uses: arduino/setup-task@v1

      - name: ğŸ” Docker login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ env.GHCR_USER }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Build Docker image (again)
        run: task docker-build

      - name: ğŸ’¾ Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: ${{ runner.os }}-trivy-db
          restore-keys: |
            ${{ runner.os }}-trivy-db

      - name: ğŸ” Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@0.32.0
        with:
          image-ref: 'ghcr.io/${{ env.GHCR_USER }}/go-hotels:${{ github.sha }}'
          severity: 'HIGH,CRITICAL'
          exit-code: 1

  docker-push:
    name: ğŸš€ Push Docker Image
    runs-on: ubuntu-latest
    needs: [docker-scan, docker-build, security-check, integration, unit-tests, lint, load-tests]
    steps:
      - name: ğŸ›’ Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Task
        uses: arduino/setup-task@v1

      - name: ğŸ” Docker login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ env.GHCR_USER }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Rebuild Docker image
        run: task docker-build

      - name: ğŸ“¤ Push Docker image
        run: task docker-push
